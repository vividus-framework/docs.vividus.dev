name: Vividus Documentation Deployment

on:
  pull_request:
    branches:
    - master

jobs:
  build:
    runs-on: 'ubuntu-latest'
    steps:
    - uses: actions/checkout@v2

    - name: Install node
      uses: actions/setup-node@v2.5.1
      with:
        node-version: 12.18.1
    - run: npm i -g @antora/cli antora-site-generator-lunr
    - run: npm install -g gitlab:antora/xref-validator
    - run: DOCSEARCH_ENABLED=true DOCSEARCH_ENGINE=lunr DOCSEARCH_INDEX_VERSION=latest NODE_PATH="$(npm -g root)" antora --generator antora-site-generator-lunr ./antora-playbook.yml

    - name: Antora links check
      shell: bash
      run: |
        errors=$(antora --generator @antora/xref-validator antora-playbook-local.yml | grep "\"refname\":\"master\"");
        if [[ -z "$errors" || "" == "$errors" ]]; then
          echo "No errors found";
        else
          echo "$errors";
          exit 1;
        fi
